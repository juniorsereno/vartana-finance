<%= content_for :page_title, t(".page_title") %>

<% if @newly_created && @plain_key %>
  <%= settings_section title: t(".created_title"), subtitle: t(".created_subtitle") do %>
    <div class="space-y-4">
      <div class="p-3 shadow-border-xs bg-container rounded-lg">
        <div class="flex items-start gap-3">
          <%= render DS::FilledIcon.new(
            icon: "check-circle",
            rounded: true,
            size: "lg",
            variant: :success
          ) %>
          <div class="flex-1">
            <h3 class="font-medium text-primary"><%= t(".created_success_title") %></h3>
            <p class="text-secondary text-sm mt-1"><%= t(".created_success_body_html", name: @current_api_key.name) %></p>
          </div>
        </div>
      </div>

      <div class="bg-surface-inset rounded-xl p-4">
        <h4 class="font-medium text-primary mb-3"><%= t(".your_api_key") %></h4>
        <p class="text-secondary text-sm mb-3"><%= t(".copy_key_description") %></p>

        <div class="bg-container rounded-lg p-3 border border-primary" data-controller="clipboard">
          <div class="flex items-center justify-between gap-3">
            <code id="api-key-display" class="font-mono text-sm text-primary break-all" data-clipboard-target="source"><%= @current_api_key.plain_key %></code>
            <%= render DS::Button.new(
              text: t(".copy_api_key"),
              variant: "ghost",
              icon: "copy",
              data: { action: "clipboard#copy" }
            ) %>
          </div>
        </div>
      </div>

      <div class="bg-surface-inset rounded-xl p-4">
        <h4 class="font-medium text-primary mb-3"><%= t(".how_to_use_title") %></h4>
        <p class="text-secondary text-sm mb-3"><%= t(".how_to_use_body") %></p>
        <div class="bg-container rounded-lg p-3 font-mono text-sm text-primary border border-primary">
          curl -H "X-Api-Key: <%= @current_api_key.plain_key %>" <%= request.base_url %>/api/v1/accounts
        </div>
      </div>

      <div class="flex justify-end pt-4 border-t border-primary">
        <%= render DS::Link.new(
          text: t(".continue_to_settings"),
          href: settings_api_key_path,
          variant: "primary"
        ) %>
      </div>
    </div>
  <% end %>
<% elsif @current_api_key %>
  <%= settings_section title: t(".your_api_key"), subtitle: t(".manage_api_key") do %>
    <div class="space-y-4">
      <div class="p-3 shadow-border-xs bg-container rounded-lg flex justify-between items-center">
        <div class="flex items-center gap-3">
          <%= render DS::FilledIcon.new(
            icon: "key",
            rounded: true,
            size: "lg"
          ) %>

          <div class="text-sm space-y-1">
            <p class="text-primary font-medium"><%= @current_api_key.name %></p>
            <p class="text-secondary">
              <%= t(".created_at_html", time: time_ago_in_words(@current_api_key.created_at)) %>
              <% if @current_api_key.last_used_at %>
                • <%= t(".last_used_at_html", time: time_ago_in_words(@current_api_key.last_used_at)) %>
              <% else %>
                • <%= t(".never_used") %>
              <% end %>
            </p>
          </div>
        </div>

        <div class="rounded-md bg-success px-2 py-1">
          <p class="text-success-foreground font-medium text-xs"><%= t(".active") %></p>
        </div>
      </div>

      <div class="bg-surface-inset rounded-xl p-4">
        <h4 class="font-medium text-primary mb-3"><%= t(".permissions") %></h4>
        <div class="flex flex-wrap gap-2">
          <% @current_api_key.scopes.each do |scope| %>
            <span class="inline-flex items-center gap-1 px-2 py-1 bg-primary text-primary-foreground rounded-full text-xs font-medium">
              <%= icon("shield-check", class: "w-3 h-3") %>
              <%= case scope
                  when "read" then t(".read_only")
                  when "read_write" then t(".read_write")
                  else scope.humanize
                  end %>
            </span>
          <% end %>
        </div>
      </div>

      <div class="bg-surface-inset rounded-xl p-4">
        <h4 class="font-medium text-primary mb-3"><%= t(".your_api_key") %></h4>
        <p class="text-secondary text-sm mb-3"><%= t(".copy_key_description") %></p>

        <div class="bg-container rounded-lg p-3 border border-primary" data-controller="clipboard">
          <div class="flex items-center justify-between gap-3">
            <code id="api-key-display" class="font-mono text-sm text-primary break-all" data-clipboard-target="source"><%= @current_api_key.plain_key %></code>
            <%= render DS::Button.new(
              text: t(".copy_api_key"),
              variant: "ghost",
              icon: "copy",
              data: { action: "clipboard#copy" }
            ) %>
          </div>
        </div>
      </div>

      <div class="bg-surface-inset rounded-xl p-4">
        <h4 class="font-medium text-primary mb-3"><%= t(".how_to_use_title") %></h4>
        <p class="text-secondary text-sm mb-3"><%= t(".how_to_use_body") %></p>
        <div class="bg-container rounded-lg p-3 font-mono text-sm text-primary border border-primary">
          curl -H "X-Api-Key: <%= @current_api_key.plain_key %>" <%= request.base_url %>/api/v1/accounts
        </div>
      </div>

      <div class="flex flex-col sm:flex-row gap-3 pt-4 border-t border-primary">
        <%= render DS::Link.new(
          text: t(".create_new_key"),
          href: new_settings_api_key_path(regenerate: true),
          variant: "secondary"
        ) %>

        <%= render DS::Button.new(
          text: t(".revoke_key"),
          href: settings_api_key_path,
          method: :delete,
          variant: "destructive",
          data: {
            turbo_confirm: t(".revoke_key_confirm")
          }
        ) %>
      </div>
    </div>
  <% end %>
<% else %>
  <%= settings_section title: t(".create_your_api_key"), subtitle: t(".get_programmatic_access") do %>
    <div class="space-y-4">
      <div class="p-3 shadow-border-xs bg-container rounded-lg">
        <div class="flex items-start gap-3">
          <%= render DS::FilledIcon.new(
            icon: "key",
            rounded: true,
            size: "lg"
          ) %>
          <div class="flex-1">
            <h3 class="font-medium text-primary"><%= t(".access_data_programmatically") %></h3>
            <p class="text-secondary text-sm mt-1"><%= t(".generate_api_key_description") %></p>
          </div>
        </div>
      </div>

      <div class="bg-surface-inset rounded-xl p-4">
        <h4 class="font-medium text-primary mb-3"><%= t(".what_you_can_do") %></h4>
        <ul class="space-y-2 text-sm text-secondary">
          <li class="flex items-start gap-2">
            <%= icon("check", class: "w-4 h-4 text-primary mt-0.5") %>
            <span><%= t(".access_accounts_and_balances") %></span>
          </li>
          <li class="flex items-start gap-2">
            <%= icon("check", class: "w-4 h-4 text-primary mt-0.5") %>
            <span><%= t(".view_transaction_history") %></span>
          </li>
          <li class="flex items-start gap-2">
            <%= icon("check", class: "w-4 h-4 text-primary mt-0.5") %>
            <span><%= t(".create_new_transactions") %></span>
          </li>
          <li class="flex items-start gap-2">
            <%= icon("check", class: "w-4 h-4 text-primary mt-0.5") %>
            <span><%= t(".integrate_with_third_party") %></span>
          </li>
        </ul>
      </div>

      <div class="flex justify-start">
        <%= render DS::Link.new(
          text: t(".create_api_key"),
          href: new_settings_api_key_path,
          variant: "primary"
        ) %>
      </div>
    </div>
  <% end %>
<% end %>
